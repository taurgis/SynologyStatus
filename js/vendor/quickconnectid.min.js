/*
 * js-quickconnectid v0.1 (https://github.com/taurgis/js-quickconnectid)
 *
 * Copyright 2017, Thomas Theunen
 * https://www.thomastheunen.eu
 *
 * Licensed under the MIT license:
 * http://www.opensource.org/licenses/MIT
 */

var QuickConnect=function(m){function n(c,b){for(var a=0,d="<br/><br /><b>Attempted following locations:</b> <br />",e=0;e<f.length;e++){var g=f[e];g.onload=function(){if(this.readyState===XMLHttpRequest.DONE&&200===this.status&&JSON.parse(this.responseText).success){for(var a=0;a<f.length;a++){var b=f[a];b!==this&&b.abort()}c("https://"+this.ip+":"+this.port)}};g.onerror=function(c){d+="  - "+c.target.ip+":"+c.target.port+"<br />";++a===f.length&&b&&b("No server found."+d+"<br /> Possible solution is to visit the locations manually to allow https over IP addresses. (ssl certificate error)")};
g.send(null)}}function p(c){var b=[{version:1,command:"get_server_info",stop_when_error:"false",stop_when_success:"false",id:"dsm_portal_https",serverID:h},{version:1,command:"get_server_info",stop_when_error:"false",stop_when_success:"false",id:"dsm_portal",serverID:h}],a=new XMLHttpRequest;a.open("POST","https://synologyquickconnectid.herokuapp.com/server.php",!0);a.onload=function(){if(a.readyState===XMLHttpRequest.DONE&&200===a.status){var b=JSON.parse(a.responseText);c(b)}};a.send(JSON.stringify(b));
return a}function q(c,b){if(c.env.control_host){var a={command:"request_tunnel",version:1,serverID:h,id:"dsm_portal_https"},d=new XMLHttpRequest;d.open("POST","https://synologyquickconnectid.herokuapp.com/server.php?host="+c.env.control_host,!0);d.onload=function(){if(d.readyState===XMLHttpRequest.DONE&&200===d.status){var a=JSON.parse(d.responseText);b(a)}else b()};d.send(JSON.stringify(a))}else b()}function l(c){var b=c.service.relay_ip;c=c.service.relay_port;b&&(b=k(b,c),f.push(b))}function r(c){var b=
c.service.port;if(c.server["interface"])for(var a=0;a<c.server["interface"].length;a++){var d=c.server["interface"][a];if(d.ip){var e=k(d.ip,b);f.push(e)}if(d.ipv6&&0<d.ipv6.length)for(e=0;e<d.ipv6.length;e++){var g=k("["+d.ipv6[a].address+"]",b);f.push(g)}}}function k(c,b){var a=new XMLHttpRequest;a.ip=c;a.port=b;a.open("GET","https://"+c+(b?":"+b:"")+"/webman/pingpong.cgi?action=cors",!0);return a}var h=m,f=[];return{determineServerURL:function(c,b){p(function(a){a[0].server&&a[0].service?q(a[0],
function(d){d&&l(d);r(a[0]);l(a[0]);n(function(a){c&&c(a)},function(a){b&&b(a)})}):b&&b("No server found")})}}};
