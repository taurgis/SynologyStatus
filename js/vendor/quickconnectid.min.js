/*
 * js-quickconnectid v0.2 (https://github.com/taurgis/js-quickconnectid)
 *
 * Copyright 2017, Thomas Theunen
 * https://www.thomastheunen.eu
 *
 * Licensed under the MIT license:
 * http://www.opensource.org/licenses/MIT
 */

var QuickConnect=function(n,p){function q(c,b){for(var d=0,e="<br/><br /><b>Attempted following locations:</b> <br />",a=0;a<f.length;a++){var g=f[a];g.onload=function(){if(this.readyState===XMLHttpRequest.DONE&&200===this.status&&JSON.parse(this.responseText).success){for(var b=0;b<f.length;b++){var a=f[b];a!==this&&a.abort()}c("https://"+this.ip+":"+this.port)}};g.onerror=function(a){e+='  - <a target="_blank" href="https://'+a.target.ip+":"+a.target.port+'">https://'+a.target.ip+":"+a.target.port+
"</a><br />";++d===f.length&&b&&b("No server found."+e+"<br /> Possible solution is to visit the locations manually to allow https over IP addresses. (ssl certificate error)")};g.send(null)}}function r(c,b){var d=[{version:1,command:"get_server_info",stop_when_error:"false",stop_when_success:"false",id:"dsm_portal_https",serverID:h},{version:1,command:"get_server_info",stop_when_error:"false",stop_when_success:"false",id:"dsm_portal",serverID:h}],e=new XMLHttpRequest;e.open("POST","https://global.quickconnect.to/Serv.php",
!0);e.onload=function(){if(e.readyState===XMLHttpRequest.DONE&&200===e.status){var a=JSON.parse(e.responseText);c(a)}};e.onerror=l?function(){var a=new XMLHttpRequest;a.open("POST","https://synologyquickconnectid.herokuapp.com/server.php",!0);a.onload=function(){if(a.readyState===XMLHttpRequest.DONE&&200===a.status){var b=JSON.parse(a.responseText);c(b)}};a.send(JSON.stringify(d))}:function(){b&&b("CORS error")};e.send(JSON.stringify(d))}function t(c,b,d){if(c.env.control_host){var e={command:"request_tunnel",
version:1,serverID:h,id:"dsm_portal_https"},a=new XMLHttpRequest;a.open("POST","https://"+c.env.control_host+"/Serv.php",!0);a.onload=function(){if(a.readyState===XMLHttpRequest.DONE&&200===a.status){var c=JSON.parse(a.responseText);b(c)}else b()};a.onerror=l?function(){var a=new XMLHttpRequest;a.open("POST","https://synologyquickconnectid.herokuapp.com/server.php?host="+c.env.control_host,!0);a.onload=function(){if(a.readyState===XMLHttpRequest.DONE&&200===a.status){var c=JSON.parse(a.responseText);
b(c)}else b()};a.send(JSON.stringify(e))}:function(){d&&d("CORS error")};a.send(JSON.stringify(e))}else b()}function m(c){var b=c.service.relay_ip;c=c.service.relay_port;b&&(b=k(b,c),f.push(b))}function u(c){var b=c.service.port;if(c.server["interface"])for(var d=0;d<c.server["interface"].length;d++){var e=c.server["interface"][d];if(e.ip){var a=k(e.ip,b);f.push(a)}if(e.ipv6&&0<e.ipv6.length)for(a=0;a<e.ipv6.length;a++){var g=k("["+e.ipv6[d].address+"]",b);f.push(g)}}}function k(c,b){var d=new XMLHttpRequest;
d.ip=c;d.port=b;d.open("GET","https://"+c+(b?":"+b:"")+"/webman/pingpong.cgi?action=cors",!0);return d}var h=n,f=[],l=p;return{determineServerURL:function(c,b){r(function(d){d[0].server&&d[0].service?t(d[0],function(e){e&&m(e);u(d[0]);m(d[0]);q(function(a){c&&c(a)},function(a){b&&b(a)})}):b&&b("No server found")},function(){b("No server found ")})}}};
