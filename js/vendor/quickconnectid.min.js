/*
 * js-quickconnectid v0.1 (https://github.com/taurgis/js-quickconnectid)
 *
 * Copyright 2017, Thomas Theunen
 * https://www.thomastheunen.eu
 *
 * Licensed under the MIT license:
 * http://www.opensource.org/licenses/MIT
 */

var QuickConnect=function(l){function m(c,b){for(var a=0;a<f.length;a++){var d=f[a];d.onload=function(){if(this.readyState===XMLHttpRequest.DONE&&200===this.status&&JSON.parse(this.responseText).success){for(var a=0;a<f.length;a++){var b=f[a];b!==this&&b.abort()}c("https://"+this.ip+":"+this.port)}};d.send(null)}}function n(c){var b=[{version:1,command:"get_server_info",stop_when_error:"false",stop_when_success:"false",id:"dsm_portal_https",serverID:g},{version:1,command:"get_server_info",stop_when_error:"false",
stop_when_success:"false",id:"dsm_portal",serverID:g}],a=new XMLHttpRequest;a.open("POST","https://synologyquickconnectid.herokuapp.com/server.php",!0);a.onload=function(){if(a.readyState===XMLHttpRequest.DONE&&200===a.status){var b=JSON.parse(a.responseText);c(b)}};a.send(JSON.stringify(b));return a}function p(c,b,a){if(c.env.control_host){var d={command:"request_tunnel",version:1,serverID:g,id:"dsm_portal_https"},e=new XMLHttpRequest;e.open("POST","https://synologyquickconnectid.herokuapp.com/server.php?host="+
c.env.control_host,!0);e.onload=function(){if(e.readyState===XMLHttpRequest.DONE&&200===e.status){var c=JSON.parse(e.responseText);b(c)}else a()};e.send(JSON.stringify(d))}else b()}function k(c){var b=c.service.relay_ip,a=c.service.relay_port;c=c.env.relay_region;b&&(b=h(b,a),f.push(b));c&&(b=h(g+"."+c+".quickconnect.to"),f.push(b))}function q(c){var b=c.service.port;if(c.server["interface"])for(var a=0;a<c.server["interface"].length;a++){var d=c.server["interface"][a];if(d.ip){var e=h(d.ip,b);f.push(e)}if(d.ipv6&&
0<d.ipv6.length)for(e=0;e<d.ipv6.length;e++){var g=h("["+d.ipv6[a].address+"]",b);f.push(g)}}}function h(c,b){var a=new XMLHttpRequest;a.ip=c;a.port=b;a.open("GET","https://"+c+(b?":"+b:"")+"/webman/pingpong.cgi?action=cors",!0);return a}var g=l,f=[];return{determineServerURL:function(c,b){n(function(a){a[0].server&&a[0].service?p(a[0],function(d){d&&k(d);q(a[0]);k(a[0]);m(function(a){c&&c(a)},function(a){b&&b(a)})}):b&&b("No server found")})}}};
